// App.jsx からインポート文を移動
import { THEMES } from "../templates"; // 相対パスを修正
import { marked, Marked } from "marked";
import markedKatex from "marked-katex-extension";

/** Gemini APIに送信するプロンプトを一元管理 */
export const PROMPTS = {
  structureText: (text) => `### 指示
あなたは、与えられたテキストをクリーンアップし、論理構造を解析する専門家です。以下のテキストに含まれる、PDF抽出時に発生しがちな単語間の不自然なスペース（例：「ドキュメント」が「ドキュ メント」となっている箇所）を修正し、自然な文章にしてください。
その上で、内容を論理的に整理し、見出し、リスト、段落が明確に分かるMarkdown形式に再構成してください。元のテキストに含まれる重要な情報は一切省略しないでください。

### テキスト
${text}`,

  analyzeContext: (text) => `### 指示
あなたは、与えられたドキュメントの「目的」と「対象者」を分析する専門家です。
以下のテキストを読み、「スライド生成AIの思考フレームワーク」に基づいて、この資料の主要な「目的」と「対象者」を推測し、指定されたJSON形式で出力してください。

### スライド生成AIの思考フレームワーク（抜粋）
1.  **目的 (Purpose)**
    * \`approval\`: 承認・合意形成（例：提案書、企画書）
    * \`information_sharing\`: 情報共有・記録（例：報告書、議事録）
    * \`education\`: 教育・理解促進（例：マニュアル、ガイドライン）
2.  **対象者 (Audience)**
    * \`expert\`: 専門家・担当者（専門用語が多い、データ中心）
    * \`manager\`: 経営層・マネージャー（ビジョン、戦略、KGIなど）
    * \`beginner\`: 一般・初心者（平易な言葉遣い、基礎的な内容）

### 思考プロセス
1.  テキスト全体をスキャンし、キーワード（例：「～提案書」「～報告書」）や文体、使用語彙レベルを分析します。
2.  上記フレームワークに基づき、「目的」と「対象者」をそれぞれ1つずつ特定します。
3.  特定した結果を、厳格なJSON形式で出力します。

### 出力形式 (JSON)
- **最重要**: 出力はJSONオブジェクトの文字列のみとし、前後に\`\`\`jsonや説明文を含めないでください。
{
  "purpose": "(approval, information_sharing, education のいずれか)",
  "audience": "(expert, manager, beginner のいずれか)"
}

### 分析対象のテキスト
${text}
`,
  createOutline: (markdown, includeAgenda, useSectionHeaders, context) => {
    // ★ 引数は変更なし
    const agendaCondition = includeAgenda
      ? `- 2枚目は必ず"アジェンダ"ページとし、\`template\`は\`agenda\`を選択してください。\`summary\`には3枚目以降のタイトルを改行区切りでリストアップしてください。\n- **【アジェンダの分割ルール】**: アジェンダの項目（\`summary\`にリストアップする3枚目以降のタイトル）が**6個を超えた**場合、\`template\`が\`agenda\`のスライドを**複数枚に分割**してください。\n- 1枚目のタイトルは『**アジェンダ (1/2)**』、2枚目は『**アジェンダ (2/2)**』のように、必ず連番を付与してください。\n- 各アジェンダスライドには、最大6項目までのリストを配置してください。`
      : "- **アジェンダページは絶対に作成しないでください。**";
    const sectionHeaderCondition = useSectionHeaders
      ? "- Markdownの主要な見出し（章やセクション）の前に、`template`が`section_header`のスライドを自動で挿入してください。"
      : "- `section_header`テンプレートは使用しないでください。";

    // ▼▼▼ Phase 3 (Step 3.1) 修正 ▼▼▼
    const docContext = context || {
      purpose: "information_sharing",
      audience: "expert",
    };

    // AIに「思考フレームワーク」そのものを指示する
    const contextInstruction = `### 分析されたドキュメントの文脈
- **目的 (Purpose)**: \`${docContext.purpose}\`
- **対象者 (Audience)**: \`${docContext.audience}\`

### 文脈に基づくストーリーラインの再構築（最重要）
あなたは、元のMarkdownの順序に縛られる必要はありません。
以下の「思考フレームワーク」に基づき、分析した「目的」と「対象者」にとって**最も説得力のあるストーリーライン**に、Markdownの内容を**並べ替え（再構築）**てください。

#### 思考フレームワーク: ステップ3（抜粋）
1.  **目的が \`approval\` (承認・合意形成) の場合:**
    * **判断:** 元の順序を**破壊し、再構築**する。（説得力が重要）
    * **採用すべき型:** 「結論ファースト型」（[結論]→[根拠]→[具体策]→[結論]） または「問題解決型」（[背景・課題]→[原因]→[解決策]→[実行計画]） を適用してください。

2.  **目的が \`education\` (教育・理解促進) の場合:**
    * **判断:** 元の順序を**尊重する**ことを基本とするが、ステップが分かりにくい場合は再構築する。
    * **採用すべき型:** 「時系列型」（[過去]→[現在]→[未来]） や「ステップバイステップ型」 を適用してください。

3.  **目的が \`information_sharing\` (情報共有・記録) の場合:**
    * **判断:** 元の順序を**厳格に尊重する**。（元の順序が重要）
    * **採用すべき型:** 元のMarkdownの目次構成（時系列やトピック別）をそのまま維持してください。

4.  **対象者への最適化:**
    * 対象者が \`manager\` (経営層) の場合: 情報を大胆に要約し、**キラーフレーズ（結論）**やサマリーを優先的に抽出してください。
    * 対象者が \`expert\` (専門家) の場合: 詳細なデータや根拠をある程度残してください。
    * 対象者が \`beginner\` (初心者) の場合: 視覚的な比率を高めることを意識し、平易な言葉で要約してください。
`;
    // ▲▲▲ 修正ここまで ▲▲▲

    return `### 指示
あなたはプロのプレゼンテーション構成作家です。以下のMarkdownテキストと「文脈」を分析し、最も効果的なプレゼンテーションの構成案をJSON形式で作成してください。

${contextInstruction} // ★ 強化した指示を挿入

### 利用可能なテンプレート
- \`title_slide\`: 表紙
- \`agenda\`: 目次
- \`section_header\`: 章の区切り
- \`highlighted_number\`: **【NEW】単一の最重要数値**（KPI、達成率など）を左に、**解説文**を右に配置（2カラム）。
- \`table_basic\`: **表形式（テーブル）**。機能一覧、比較表、数値データなど。
- \`bar_chart\`: 複数の数値（割合、スコアなど）を視覚的に比較するための棒グラフ。
- \`comparison\`: **2〜4つの項目（メリット/デメリット、A案/B案/C案など）を比較・対比**するための専用テンプレート。
- \`three_points\`: 3つの要点を横並びで表示。
- \`vertical_steps\`: 時系列やステップ。
- \`math_basic\`: **単一の主要な数式**とその解説（上下分割）。
- \`quote\`: **【NEW】重要な結論、キラーフレーズ、引用文**を中央に表示。
- \`content_with_diagram\`: 文章と図解（インフォグラフィック）。
- \`content_basic\`: **単純な箇条書き**（番号なし・あり両方）のための最も標準的なテンプレート。
- \`summary_or_thankyou\`: 最後のまとめ、または「ご聴取ありがとうございました」用。

### テンプレート選択の思考プロセスと具体例
あなたはMarkdownの各セクションを分析する際、以下の優先順位と思考プロセスでテンプレートを厳格に選択してください。

1.  **[最優先] 単一の重要数値か？**: 内容が「売上達成率: 98%」「KPI: 150件」のように、**単一の最重要数値**をハイライトし、**その数値に関する補足説明文**（例：数値の意味、背景など）も記述されている場合は、必ず \`highlighted_number\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 今期の最重要KPI
        今期の売上達成率は98%に達しました。これは目標をほぼ達成したことを示します。
        
        **達成の背景**
        - 新機能Aのリリースが貢献
        - マーケティング施策の成功
        \`\`\`
    * **出力テンプレート**: \`highlighted_number\`

2.  **[次点] 表形式か？**: 内容が機能一覧、数値データ、仕様比較など、明らかに表（テーブル）で表現するのが最適な場合は、必ず \`table_basic\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 機能比較
        | 機能 | プランA | プランB |
        |---|---|---|
        | 基本機能 | 〇 | 〇 |
        | 高度な分析 | - | 〇 |
        \`\`\`
    * **出力テンプレート**: \`table_basic\`

3.  **[次点] 比較・対比か？**: 内容が **2〜4つの項目**（例：メリット/デメリット、A案/B案、従来/新規、プランA/B/C）を明確に比較・対比している場合は、必ず \`comparison\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 従来システムとの比較
        **従来システム**
        - 課題1: コストが高い
        - 課題2: 手動作業が多い
        **新システム**
        - 解決策1: 50%のコスト削減
        - 解決策2: 自動化を実現
        \`\`\`
    * **出力テンプレート**: \`comparison\`

4.  **[次点] 複数数値の視覚的比較か？**: 内容が複数の項目とそれぞれの数値（例: カテゴリA: 75%, B: 50%）を比較しており、テキストや単純な箇条書きよりも**棒グラフ**で表現するのが直感的で最適だと判断した場合、必ず \`bar_chart\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 各カテゴリの進捗
        - カテゴリA: 75%
        - カテゴリB: 50%
        - カテゴリC: 90%
        \`\`\`
    * **出力テンプレート**: \`bar_chart\`
    * **AIの判断**: \`table_basic\` や \`comparison\` よりも、添付画像のような視覚的なグラフが適していると判断した場合にこれを選択する。

5.  **[次点] 3つの要点か？**: 内容が3つの主要な特徴、ステップ、利点を並列で紹介している場合は、\`three_points\` の使用を優先します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 3つのメリット
        1.  **コスト削減**: ...
        2.  **効率化**: ...
        3.  **セキュリティ向上**: ...
        \`\`\`
    * **出力テンプレート**: \`three_points\`

6.  **[次点] ステップか？**: 内容が時系列や手順を示している場合は、\`vertical_steps\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 導入プロセス
        - ステップ1: ヒアリング
        - ステップ2: 設計
        - ステップ3: 開発
        \`\`\`
    * **出力テンプレート**: \`vertical_steps\`

7.  **[次点] 主要な数式か？**: 内容が**単一の主要な数式ブロック（$$...$$）**とその解説文で構成されている場合（数式が主題の場合）、必ず \`math_basic\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### 二次方程式の解
        二次方程式 $ax^2 + bx + c = 0$ の解は、以下の公式で与えられます。
        $$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$
        この $b^2 - 4ac$ の部分を判別式と呼びます...
        \`\`\`
    * **出力テンプレート**: \`math_basic\`

8.  **[次点] 重要な引用か？**: 内容が本文中の「キラーフレーズ」や「重要な結論」、「...と述べた」のような引用文であると判断した場合、必ず \`quote\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        ...以上の分析から、我々はAプランが最適解であると結論付けた。このキラーフレーズは補足説明が必要である。
        \`\`\`
    * **出力テンプレート**: \`quote\`

9.  **[次点] 図解が必要か？**: 内容が抽象的な概念や関係性（例：システム構成図、相関関係）を含み、テキストだけでは伝わりにくい場合、**かつ上記の専用テンプレートに当てはまらない場合**は、\`content_with_diagram\` を選択します。
    * **入力例 (Markdown)**:
        \`\`\`markdown
        #### システム構成
        本システムは、ユーザー、アプリケーションサーバー、データベースの3層構造で構成されており...
        \`\`\`
    * **出力テンプレート**: \`content_with_diagram\`

10.  **[最終手段] 単純なリストか？**: 上記のいずれにも当てはまらない、単純な箇条書きや説明文の場合は、\`content_basic\` を選択します。

### 条件
- 1枚目は必ず\`template\`が\`title_slide\`のタイトルページとしてください。タイトルはMarkdownの内容から最も適切と思われるものを自動で設定してください。
- **【最重要・JSONエスケープルール】**: \`summary\`や\`description\`などのJSON文字列内にバックスラッシュ（\`\\\`）を含める場合は、必ず（\`\\\\\`）と二重にエスケープしてください。（例: \`"summary": "C:\\\\Windows"\`）
- **【文字数制限】**: スライドのタイトル（\`title\`キー）は、日本語で**27文字以内**の簡潔なものにしてください。長すぎて2行になるタイトルは避けてください。
- **最重要**: \`summary\`や各項目の説明は、**プレゼンテーションでそのまま使える簡潔な言葉**で記述し、必要に応じて箇条書き（- や 1.）を使用してください。

- **【強調ルール】**: \`summary\`, \`items\`, \`points\`, \`columns\`, \`table\`, \`description\`, \`content_title\` の各テキストを生成する際、**プレゼンテーションで特に重要となるキーワード、専門用語、またはキーとなる数値**は、必ずMarkdownの太字記法（\`**キーワード**\`）で囲んで積極的に強調してください。
- **【用語解説ルール】**: もし \`用語：その解説\` のような形式で記述する場合は、必ず \`**用語**：その解説\` のように、コロン（：）の前の用語部分を太字にしてください。

- **【▼▼▼ 修正（NEW） ▼▼▼】**
- **【Markdownエスケープ禁止ルール】**: \`summary\`, \`description\`, \`content_title\` などのキーにMarkdown（例: \`**強調**\`）を含める際、**絶対にバックスラッシュ（\`\\\`）でエスケープしないでください。**
  - **悪い例**: \`"summary": "これは \\\`**\\\`**強調\\\`**\\\`** です。"\`
  - **良い例**: \`"summary": "これは **強調** です。"\`

- **【数式表示ルール】**: もし内容に数式、変数、または計算式（例： \`y = ax + b\` や \`費用 - 収益\`）が含まれる場合は、**必ず KaTeX 形式**で記述してください。
  - **インライン数式**: 文中の数式は、シングルダラー（\`$\`）で囲んでください。（例: \`これは $y = ax + b$ の例です。\`）
  - **ブロック数式**: 独立した行の数式は、ダブルダラー（\`$$\`）で囲んでください。（例: \`$$ \sum_{i=1}^{n} x_i $$ \`）
  - **【最重要】日本語の変数名**: 数式内で日本語の用語（例：\`課税譲渡所得金額\`）を使用する場合は、必ず \`\text{...}\` コマンドで囲んでください。（例: \`$$ \text{課税譲渡所得金額} = \text{収入金額} - (\text{取得費} + \text{譲渡費用}) - \text{特別控除額} $$ \`）

- **上記の専用テンプレート（table_basic, comparison, three_points など）のいずれにも当てはまらない**、単純な箇条書き（番号付き/なし）が中心のスライドを作成する場合に**のみ**、\`content_basic\` テンプレートを使用してください。
  - \`content_basic\` を選択した場合、**\`summary\`キーは絶対に空（""）**にし、代わりに **\`items\`キー** で「箇条書きの各項目（文字列）」の配列を生成してください。
  - **【最重要】\`items\` の各項目（文字列）の先頭には、ハイフン（-）やアスタリスク（*）、数字（1.）などのリストマーカーを**絶対に**含めないでください。（CSSで自動付与されます）
  - もし箇条書きを**ネスト（インデント）**させたい場合は、項目の先頭に**半角スペース2個**を挿入してください。（例： \`"  これが子項目です"\`）
  - 孫項目は半角スペース4個（\`"    これが孫項目です"\`）のように表現してください。
  - **【行数制限】**: スライドの視認性を保つため、\`content_basic\` の \`items\` 配列は **最大7行（7項目）程度** に収めてください。
  - **【自動分割】**: もし元のデータがこのサイズに **要約しきれないほど多い場合**、無理に1枚に押し込めたり、情報を省略したりしないでください。
  - **【分割ルール】**: その場合、\`template\` が \`content_basic\` のスライドを **複数枚に分割** してください。（例：1枚目のタイトルを「**主な特長 (1/2)**」、2枚目のタイトルを「**主な特長 (2/2)**」のようにし、8行目以降の項目を2枚目に配置してください。）

- **2〜4つの項目を比較・対比**し、\`comparison\` テンプレートを使用する場合は、\`summary\`は空にし、代わりに\`columns\`というキーで **2〜4要素** の配列（\`{title: "...", items: [...]}\`）を生成してください。
  - **【最重要・比較項目ルール】**: \`items\` 配列の各文字列は、**\`"**項目名**\`：\`** \`内容\`"\` の形式（例：\`"**価格**：10,000円"\`）を**可能な限り使用してください。**
  - これにより、何（価格、機能など）を比較しているかが明確になります。

- **表形式（テーブル）が最適なデータ**（例：機能比較一覧、数値データ一覧など）を表現し、\`table_basic\` テンプレートを使用する場合は、
  - **\`summary\`キーには、その表に関する補足説明や解説文をMarkdown形式で記述してください。** 解説が不要な場合は空（""）にしてください。  - **【表の重要ルール】**: スライドの視認性を保つため、\`table_basic\` の表は **最大7行、5列程度** に収めてください。
  - **【最重要・高さ考慮】**: 上記の行数制限（7行）を守っていても、**各セルのテキスト量（文字数）が非常に多い**場合、テーブル全体の高さが1枚のスライドに収ままらなくなる可能性があります。
  - **AIは常にこの「高さ」を意識してください。** もし1つのセルが長くなりすぎる場合（例：50文字を超える長文など）は、**内容を簡潔に要約**するか、**そのセル内で改行（\\n）**を適切に使用してください。
  - それでも情報が多すぎて1枚に収まらない（高さが超える）とAIが判断した場合は、行数が7行以下であっても、\`template\` が \`table_basic\` のスライドを **複数枚に分割** してください。
    - （例：1枚目のタイトルを「**機能比較 (1/2)**」、2枚目のタイトルを「**機能比較 (2/2)**」のようにし、表の続きを2枚目に配置してください。この際、**ヘッダー行は両方のスライドに含めてください**。）

- **【bar_chart ルール】**
- **複数の数値（例：進捗率、スコア）を視覚的な棒グラフで比較**し、\`bar_chart\` テンプレートを使用する場合は、
  - **\`summary\`キーは絶対に空（""）**にしてください。
  - 代わりに **\`chart_data\`キー** で、**Chart.js と互換性のある厳格なデータオブジェクト**を生成してください。
  - **【AIの思考プロセス】**:
    1.  Markdownから「ラベル」（例: カテゴリA, B, C）と「データ」（例: 75, 50, 90）を抽出します。
    2.  \`labels\` キーに「ラベルの配列（文字列）」を設定します。
    3.  \`datasets\` キーに「単一要素の配列」を設定します。
    4.  その単一要素のオブジェクト内に \`label\` キー（データセット名、例: "進捗率"）と \`data\` キー（数値の配列）を設定します。
  - **【厳格な形式】**:
    \`\`\`json
    {
      "labels": ["カテゴリA", "カテゴリB", "カテゴリC"],
      "datasets": [
        {
          "label": "進捗率 (%)",
          "data": [75, 50, 90]
        }
      ]
    }
    \`\`\`

- **【▼▼▼ 修正点 ▼▼▼】**
- \`three_points\` テンプレートを使用する場合、
  - **\`summary\`キーは絶対に空（""）**にしてください。
  - 代わりに **\`points\`キー** で、**必ず3要素のオブジェクト配列**を生成してください。
  - 各オブジェクトには **\`title\`** (文字列), **\`summary\`** (文字列), **\`icon_description\`** (文字列) の3つのキーを**必ず含めてください**。
  
  - **【icon_description の超厳格ルール】**: \`icon_description\` キーには、**Lucide (lucide.dev) のアイコン名**（例: "check-circle", "braces", "database", "shield-check", "brain-cog"）を**単一の文字列**で指定してください。
  - **【禁止事項】**: **絶対に、説明文（例: "APIのアイコン"、"RAGの図"）や、日本語、スペースを含む文字列を指定しないでください。**
  - **【あなたの思考プロセス】**:
    1.  ポイントのタイトル（例: "API"）を理解します。
    2.  Lucideライブラリから最も関連性の高いアイコン名（例: "braces" や "code"）を1つだけ選びます。
    3.  その名前（"braces"）だけを \`icon_description\` キーに設定します。
  - （例: \`{"title": "API", "summary": "...", "icon_description": "braces"}\`）
- **【▲▲▲ 修正点ここまで ▲▲▲】**

- **【▼▼▼ 修正点 ▼▼▼】**
- **【vertical_steps ルール】**
- \`vertical_steps\` テンプレートを使用する場合、
  - **\`summary\`キーは絶対に空（""）**にしてください。
  - 代わりに **\`items\`キー** で、**オブジェクトの配列**を生成してください。
  - 各オブジェクトには **\`title\`** (文字列) と **\`description\`** (文字列、そのステップの簡潔な説明) の2つのキーを**必ず含めてください**。
  - （例: \`{"title": "ステップ1：申請", "description": "必要な書類を準備します。"}\`）
- **【▲▲▲ 修正点ここまで ▲▲▲】**

- **【▼▼▼ 修正点 ▼▼▼】**
- \`content_with_diagram\` テンプレートを選択した場合、
  - **スライドの本文を必ず \`summary\` キーに記述**してください。
  - 同時に、**必ず \`infographic\` キー** で \`{ "needed": true, "description": "AIが図解を生成するための詳細な指示..." }\` の形式のオブジェクトを生成してください。
  - AIへの指示（description）は、\`summary\`の内容を図解するために具体的に記述してください。
- **【▲▲▲ 修正点ここまで ▲▲▲】**

- **【math_basic ルール】**
- \`math_basic\` テンプレートを使用する場合、
  - **\`summary\`キーに数式の解説文**（Markdown形式）を必ず記述してください。**【文字数制限】解説文は、日本語で**200文字程度**の簡潔な内容に要約してください。**
  - **\`formula\`キーにKaTeX形式の単一の数式ブロック**（例: \`$$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$\`）を必ず記述してください。
  - **【最重要・重複排除】\`summary\` キーの解説文には、\`formula\`キーに記述する数式（またはそのインライン版 $...$）を**含めないでください**。
  - （例：\`...以下の式で表されます。 $x=y$\` という文章は、\`...以下の式で表されます。\` のように、数式を省略して記述してください。）

- **【▼▼▼ 修正点（NEW） ▼▼▼】**
- **【quote ルール】**
- \`quote\` テンプレートを使用する場合、
  - **本文（引用文、キラーフレーズ）を必ず \`summary\` キーに記述**してください。
  - AIの判断で、引用文の**前後に日本語の引用符（「」）**を適切に付与してください。
  - **【NEW】** 引用文に対する**簡潔な補足文（解説文）**（例：出典、キラーフレーズの意図など）がある場合は、それを **\`description\` キー** に記述してください。
  - 補足文がない場合は \`description: ""\` としてください。
- **【highlighted_number ルール】**
- **【超厳格・numberルール】**: \`number\` キーには、**数値と単位（例: "98%", "150件", "3.14"）のみ**を格納してください。
- **【禁止事項】**: \`number\` キーに、\`description\`（例: "達成率"）や、補足的な日本語（例: "**削減**"）、Markdown（\`**\`）を**絶対​​に含めないでください**。
- \`description\` キー で、その数値の**簡潔な説明文**（例: "売上達成率", "運用コスト削減"）を必ず生成してください。
- **【AIの思考プロセス】**: もし元のテキストが「**30%削減**」のように数値と日本語がセットの場合、\`number: "30%"\` と \`description: "運用コスト削減"\` のように、**日本語は\`description\`キーに含めるか、\`summary\`キーの本文で説明**してください。
- **【NEW】\`content_title\` キー** で、右カラムに表示する**解説の見出し**（例: "数値の背景", "単一の重要数値"）を必ず生成してください。
- **【NEW】\`summary\` キー** で、右カラムに表示する**補足説明文**（Markdown形式可）を必ず生成してください。
- **【▲▲▲ 修正点ここまで ▲▲▲】**
${agendaCondition}
${sectionHeaderCondition}

- 最後のスライドは \`summary_or_thankyou\` とし、タイトルを「まとめ」または「ご清聴ありがとうございました」に設定してください。

### 出力形式(JSON)の例
- **最重要**: 出力はJSON配列の文字列のみとし、前後に\`\`\`jsonや説明文を含めないでください。
[
  { "title": "タイトルページ", "summary": "発表者名", "template": "title_slide" },
  { "title": "今期の最重要KPI", "template": "highlighted_number", "number": "98%", "description": "売上達成率", "content_title": "達成率の背景", "summary": "現在の達成率は**98%**に達しており、目標達成は確実です。\n- これは運用チームの努力によるものです。" },
  { "title": "我々の結論", "summary": "「我々の最適解は、Aプランである」", "template": "quote", "description": "− キラーフレーズや重要な結論の強調に使用。" },
  { "title": "システムの概要", "summary": "...", "template": "content_with_diagram", "infographic": { "needed": true, "description": "システム概要の構成図" } },
  { "title": "二次方程式の解", "summary": "この公式は...", "template": "math_basic", "formula": "$$ x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a} $$" },
  { 
    "title": "各カテゴリの進捗",
    "summary": "",
    "template": "bar_chart",
    "chart_data": {
      "labels": ["カテゴリA", "カテゴリB", "カテゴリC"],
      "datasets": [
        {
          "label": "進捗率 (%)",
          "data": [75, 50, 90],
          "backgroundColor": [ // (任意) AIが色を提案しても良い
            "rgba(54, 162, 235, 0.6)",
            "rgba(54, 162, 235, 0.6)",
            "rgba(54, 162, 235, 0.6)"
          ]
        }
      ]
    }
  }, 
  { 
    "title": "3つのプラン", 
    "summary": "", 
    "template": "three_points", 
    "points": [ 
      { "title": "プランA", "summary": "プランAの簡潔な説明...", "icon_description": "braces" }, 
      { "title": "プランB", "summary": "プランBの簡潔な説明...", "icon_description": "database" }, 
      { "title": "プランC", "summary": "プランCの簡潔な説明...", "icon_description": "shield-check" }
    ] 
  },
  
  { "title": "プロジェクトの3ステップ", "summary": "", "template": "vertical_steps", "items": [ {"title": "ステップ1", "description": "ステップ1の説明..."}, {"title": "ステップ2", "description": "ステップ2の説明..."} ] },
  { "title": "主な特長", "summary": "", "template": "content_basic", "items": [ "特長1", "特長2" ] },
  { 
    "title": "A案とB案とC案の比較", 
    "summary": "", 
    "template": "comparison", 
    "columns": [ 
      {"title": "A案", "items": ["**価格**：10万円", "**納期**：3週間"]}, 
      {"title": "B案", "items": ["**価格**：12万円", "**納期**：2週間"]},
      {"title": "C案", "items": ["**価格**：8万円", "**納期**：4週間"]}
    ] 
  },
  {
    "title": "機能比較表 (1/2)",
    "summary": "",
    "template": "table_basic",
    "table": {
      "headers": [ "機能名", "プランA", "プランB" ],
      "rows": [
        [ "基本機能", "〇", "〇" ],
        [ "高度な分析", "-", "〇" ],
        [ "専用サポート", "-", "-" ]
      ]
    }
  },
  { "title": "ご清聴ありがとうございました", "summary": "", "template": "summary_or_thankyou" }
]

### Markdownテキスト
${markdown}`;
  },

  generateInfographic: (description, theme) => {
    // ★ theme を引数に追加
    const themeInstructions =
      theme === "light"
        ? "・背景は白（#FFFFFF）です。図形や線には濃い色（例: #1E293B, #0284c7）を使用してください。"
        : "・背景は濃いグレー（#1e293b）です。図形や線には明るい色（例: #e2e8f0, #38bdf8）を使用してください。";

    return `### あなたの役割
あなたは、与えられた指示に基づき、情報を視覚的に表現するためのSVG（スケーラブル・ベクター・グラフィックス）コードを生成する専門家です。

### 指示
以下の「インフォグラフィックの詳細説明」を読み、その内容を表現するSVGコードを生成してください。

### 厳格なルール
- **最重要:** あなたの応答は\`<svg\`で始まり、\`</svg>\`で終わる必要があります。これ以外のXML宣言、コードブロック、解説、テキストは絶対に含めないでください。
- **【超重要】SVG内に\`<text>\`タグやその他のテキスト要素を一切含めないでください。アイコンや図形のみで内容を表現してください。**

- **【サイズ指定の厳格なルール】**:
- SVGタグには \`width="100%"\` と \`height="100%"\` を**必ず指定してください**。
- \`viewBox="0 0 100 100"\` のように、viewBox属性を必ず指定してください（値は内容に応じて調整可）。
- **絶対に \`width\` や \`height\` にピクセル値（例: \`width="500px"\`）を指定しないでください。**

- **【配色ルールの厳格なルール】**:
${themeInstructions}
- **絶対に、SVG自体に背景色（例: \`<rect width="100%" height="100%" fill="...">\`）は含めないでください。** スライドの背景を透過させる必要があります。

### インフォグラフィックの詳細説明
${description}`;
  },

  modifySlide: (modificationRequest, currentSlideHtml) => `### あなたの役割
あなたは、ユーザーの指示を100%忠実に、かつ正確にHTMLコードへ反映させる精密なコーディングアシスタントです。

### 指示
「修正対象のHTMLコード」を「ユーザーからの修正指示」に基づき修正し、その結果を厳格なJSON形式で出力してください。

### 思考プロセス
1. 「修正対象のHTMLコード」と「ユーザーからの修正指示」を完全に理解します。
2. 指示に従ってHTMLコードを修正します。
3. 実際に行った変更点を日本語の箇条書きで簡潔にまとめます。
4. 修正後の完全なHTMLコードと、まとめた変更点の両方を、指定されたJSON形式で出力します。

### 出力形式 (JSON)
- **最重要**: 出力は必ず以下の構造を持つJSONオブジェクトの文字列のみとしてください。前後に説明や\`\`\`jsonを含めないでください。
\`\`\`json
{
  "html": "(ここに修正後の完全なHTMLコードを文字列として挿入)",
  "changes": "(ここに実際に行った変更点の箇条書きを文字列として挿入。例: ・ヘッダーの文言を変更しました。\\n・背景色を#e0f7faに変更しました。)"
}
\`\`\`

### ユーザーからの修正指示
${modificationRequest}

### 修正対象のHTMLコード
\`\`\`html
${currentSlideHtml}
\`\`\`
`,
  regenerateSlideContent: (
    slideTitle,
    originalDataJson,
    newTemplateName,
    availableTemplates
  ) => {
    // 元データが空（{}）でないか確認
    const originalDataPrompt =
      originalDataJson !== "{}" && originalDataJson
        ? `### 元のスライド情報（JSON）
${originalDataJson}`
        : `### 元のスライド情報
元データはありません。タイトル「${slideTitle}」に基づいて内容を生成してください。`;

    return `### 指示
あなたはプロのプレゼンテーション構成作家です。
以下の「元のスライド情報」と「スライドタイトル」を分析し、「新しいテンプレート」の形式に最適なコンテンツを生成してください。

### スライドタイトル
${slideTitle}

${originalDataPrompt}

### 新しいテンプレート
${newTemplateName}

### 利用可能なテンプレートと必要なJSONキー
${availableTemplates.map((t) => `- **${t.name}**: ${t.description}`).join("\n")}

### 厳格な出力条件
- **最重要**: 出力は、新しいテンプレート（${newTemplateName}）に必要なキー（例: \`items\`, \`points\`, \`columns\`, \`summary\`）のみを含むJSONオブジェクトの文字列としてください。
- 前後に\`\`\`jsonや説明文は絶対に含めないでください。
- 元の情報を活用し、新しいテンプレート形式で最も伝わりやすい内容を生成してください。

### 出力例
- ${newTemplateName} が "content_basic" の場合: \`{ "items": ["項目1", "項目2", "項目3"] }\`
- ${newTemplateName} が "three_points" の場合: \`{ "points": [ { "title": "...", "summary": "...", "icon_description": "..." }, ... ] }\`
- ${newTemplateName} が "comparison" の場合: \`{ "columns": [ { "title": "A案", "items": [...] }, { "title": "B案", "items": [...] } ] }\`
- ${newTemplateName} が "table_basic" の場合: \`{ "table": { "headers": ["H1", "H2"], "rows": [["R1C1", "R1C2"], ["R2C1", "R2C2"]] } }\`
- ${newTemplateName} が "math_basic" の場合: \`{ "summary": "数式の解説...", "formula": "$$ y = ax + b $$" }\` 
- ${newTemplateName} が "content_with_diagram" の場合: \`{ "summary": "ここにスライドの本文が入ります...", "infographic": { "needed": true, "description": "..." } }\`
`;
  },

  modifyFullOutline: (currentOutlineJson, instruction) => `### 指示
あなたはプロのプレゼンテーション構成作家です。
添付された「現在の構成案(JSON)」を、以下の「ユーザーからの修正指示」に基づき、厳密に修正してください。

### 厳格なルール
- **最重要:** 出力は、修正後の**完全なJSON配列の文字列のみ**としてください。前後に\`\`\`jsonや説明文は絶対に含めないでください。
- 指示された箇所以外は、**絶対に、いかなる理由があっても変更しないでください。**
- スライドの順序変更、追加、削除、内容の書き換えなど、指示を忠実に実行してください。

### ユーザーからの修正指示
${instruction}

### 現在の構成案(JSON)
${currentOutlineJson}
`,

  modifySingleSlideOutline: (currentSlideJson, instruction) => `### 指示
あなたはプロのプレゼンテーション構成作家です。
添付された「現在のスライド(JSON)」を、以下の「ユーザーからの修正指示」に基づき、厳密に修正してください。

### 厳格なルール
- **最重要:** 出力は、修正後の**単一のJSONオブジェクトの文字列のみ**としてください。前後に\`\`\`jsonや説明文は絶対に含めないでください。
- 指示された箇所以外（例：指示がないのに \`template\` を変えるなど）は、**絶対に、いかなる理由があっても変更しないでください。**
- スライドのタイトル、要約（summary）、箇条書き（items）など、指示された部分のみを修正してください。

### ユーザーからの修正指示
${instruction}

### 現在のスライド(JSON)
${currentSlideJson}
`,
  findIconName: (description) => `### 指示
あなたは、与えられた「概念」や「説明文」を、オープンソースの「Lucide (lucide.dev)」アイコンライブラリの**単一のアイコン名**にマッピングする専門家です。

### 厳格なルール
- **最重要**: あなたの応答は、Lucideのアイコン名（例: "braces", "shield-check", "database"）**そのもの**でなければなりません。
- 解説、前置き、引用符、JSON形式などは**一切不要**です。
- 関連するアイコンが複数ある場合でも、最も代表的だと思われるものを**1つだけ**選んでください。
- 存在しないアイコン名は返さないでください。

### 例
- 入力: "API、接続、歯車"
- 出力: braces
- 入力: "セキュリティ、盾、認証"
- 出力: shield-check
- 入力: "AI、チャットボット、根拠"
- 出力: brain-cog
- 入力: "存在しない概念"
- 出力: circle

### 変換対象の説明文
${description}`,
  findIconNameRetry: (concept, wrongName) => `### 指示
あなたは、与えられた「概念」を「Lucide (lucide.dev)」の**正しいアイコン名**にマッピングする専門家です。

### 前回の失敗
前回のタスクで、あなたは「${concept}」という概念に対して「${wrongName}」という名前を返しましたが、そのアイコン名は**存在しません (404エラー)**でした。

### 厳格なルール
- **最重要**: 「${wrongName}」とは**異なる、別の正しいLucideアイコン名**を1つだけ返してください。
- 解説、前置き、引用符、JSON形式などは**一切不要**です。
- どうしても適切な名前が見つからない場合は "circle" と返してください。

### 変換対象の概念
${concept}`,
};
